@page "/MyMatches"
@implements IAsyncDisposable

@using FairPlayCombined.Common
@using FairPlayCombined.Common.CustomAttributes
@using FairPlayCombined.Common.GeneratorsAttributes
@using FairPlayCombined.Interfaces
@using FairPlayCombined.Models.FairPlayDating.UserProfile
@using FairPlayCombined.Models.Pagination
@using FairPlayCombined.Services.FairPlayDating
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Localization

@attribute [Authorize]
@rendermode @(new InteractiveServerRenderMode(prerender:false))
@inject MyMatchesService myMatchesService
@inject UserProfileService userProfileService
@inject IUserProviderService userProviderService
@inject IStringLocalizer<MyMatches> localizer

<h3>
    @localizer[MyMatchesTextKey]
</h3>

<LoadingIndicator ShowSpinners="this.IsBusy"></LoadingIndicator>

@if (!this.HasUserProfile)
{
    <p>
        @localizer[CompletProfileTextKey]
    </p>
}
<div class="grid-container">
    <FluentDataGrid ItemsProvider="this.ItemsProvider" Pagination="this.paginationState">
        <TemplateColumn>
            <div class="row">
                <div class="col">
                    <div class="card" style="width: 100%;">
                        <img class="card-img-top"
                             src="@($"api/photoimage/{context.ProfilePhotoId}")" />
                        <div class="card-body">
                            <h5 class="card-title">
                            </h5>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="row">
                        <div class="col">
                            @localizer[AgeTextKey]: @context.Age
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            @localizer[DistanceTextKey]: @context.Distance
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <p>@context.About</p>
                            <a class="btn btn-primary"
                               @onclick="@( ()=> OnViewDetailsClicked(context))">@localizer[ViewDetailsTextKey]</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <FluentPaginator State="this.paginationState"
                                             CurrentPageIndexChanged="@(()=>CurrentPageIndexChanged())"></FluentPaginator>
                        </div>
                    </div>
                </div>
            </div>
        </TemplateColumn>
    </FluentDataGrid>
</div>


<FluentDialog @ref="detailsDialog"
              @bind-Hidden="@showDetailsDialog"
              Modal="true" TrapFocus="true"
              PreventScroll="false">
    <FluentDialogHeader Visible="false"></FluentDialogHeader>
    @if (this.selectedUserProfileModel != null)
    {
        <div>
            <p>
                <FluentLabel Typo="Typography.Subject">
                    <strong>
                        Age:
                    </strong>
                </FluentLabel>
                <FluentLabel Typo="Typography.Body">@selectedUserProfileModel!.Age</FluentLabel>
            </p>
            <p>
                <FluentLabel Typo="Typography.Subject">
                    <strong>
                        About me:
                    </strong>
                </FluentLabel>
                <FluentLabel Typo="Typography.Body">@selectedUserProfileModel!.About</FluentLabel>
            </p>
            <p>
                <FluentLabel Typo="Typography.Subject">
                    <strong>
                        Kids Status:
                    </strong>
                </FluentLabel>
                <FluentLabel Typo="Typography.Body">@selectedUserProfileModel!.KidStatusText</FluentLabel>
            </p>
            <p>
                <FluentLabel Typo="Typography.Subject">
                    <strong>
                        Gender:
                    </strong>
                </FluentLabel>
                <FluentLabel Typo="Typography.Body">@selectedUserProfileModel!.BiologicalGenderText</FluentLabel>
            </p>
            <p>
                <FluentLabel Typo="Typography.Subject">
                    <strong>
                        Date Objective:
                    </strong>
                </FluentLabel>
                <FluentLabel Typo="Typography.Body">@selectedUserProfileModel!.CurrentDateObjectiveText</FluentLabel>
            </p>
            <p>
                <FluentLabel Typo="Typography.Subject">
                    <strong>
                        Eyes Color:
                    </strong>
                </FluentLabel>
                <FluentLabel Typo="Typography.Body">@selectedUserProfileModel!.EyesColorText</FluentLabel>
            </p>
            <p>
                <FluentLabel Typo="Typography.Subject">
                    <strong>
                        Hair Color:
                    </strong>
                </FluentLabel>
                <FluentLabel Typo="Typography.Body">@selectedUserProfileModel!.HairColorText</FluentLabel>
            </p>
            <p>
                <FluentLabel Typo="Typography.Subject">
                    <strong>
                        Religion:
                    </strong>
                </FluentLabel>
                <FluentLabel Typo="Typography.Body">@selectedUserProfileModel!.ReligionText</FluentLabel>
            </p>
            <p>
                <FluentLabel Typo="Typography.Subject">
                    <strong>
                        Tattoo Status:
                    </strong>
                </FluentLabel>
                <FluentLabel Typo="Typography.Body">@selectedUserProfileModel!.TattooStatusText</FluentLabel>
            </p>
        </div>
        <div>
            <FluentButton Type="ButtonType.Button" Appearance="Appearance.Accent"
                          OnClick="OnCloseSelectedProfile">Close</FluentButton>
        </div>
    }
</FluentDialog>

@code {
    private GridItemsProvider<UserProfileModel>? ItemsProvider;
    private readonly CancellationTokenSource cancellationTokenSource = new();
    private bool showDetailsDialog { get; set; } = false;
    private FluentDialog? detailsDialog { get; set; }
    private UserProfileModel? selectedUserProfileModel { get; set; }
    private bool IsBusy { get; set; }
    private bool HasUserProfile { get; set; }
    private readonly PaginationState paginationState = new()
        {
            ItemsPerPage = 1
        };

    protected override async Task OnInitializedAsync()
    {
        var userId = this.userProviderService.GetCurrentUserId();
        var userProfile = await this.userProfileService.GetUserProfileByUserIdAsync(userId!,
        this.cancellationTokenSource.Token);
        if (userProfile != null)
        {
            ItemsProvider = async req =>
            {
                this.IsBusy = true;
                StateHasChanged();
                PaginationRequest paginationRequest = new PaginationRequest()
                    {
                        PageSize = paginationState.ItemsPerPage,
                        StartIndex = req.StartIndex,
                        SortingItems = req.GetSortByProperties().Select(p => new SortingItem()
                        {
                            PropertyName = p.PropertyName,
                            SortType = p.Direction == SortDirection.Ascending ? SortType.Ascending : SortType.Descending
                        }).ToArray()
                    };

                var items = await this.myMatchesService
                .GetPagedMyPotentialMatchesAsync(paginationRequest, cancellationTokenSource.Token);
                var result = GridItemsProviderResult.From<UserProfileModel>(items!.Items!, items.TotalItems);
                this.IsBusy = false;
                StateHasChanged();
                return result;
            };
        }
        this.HasUserProfile = userProfile != null;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            this.detailsDialog!.Hide();
        }
    }

    private void OnViewDetailsClicked(UserProfileModel userProfileModel)
    {
        this.selectedUserProfileModel = userProfileModel;
        this.detailsDialog!.Show();
    }

    private void OnCloseSelectedProfile()
    {
        this.detailsDialog!.Hide();
        this.selectedUserProfileModel = null;
    }

    private void CurrentPageIndexChanged()
    {
        this.detailsDialog!.Hide();
        this.selectedUserProfileModel = null;
    }

    public ValueTask DisposeAsync()
    {
        this.cancellationTokenSource.Dispose();
        return ValueTask.CompletedTask;
    }

    [ResourceKey(defaultValue: "My Matches")]
    public const string MyMatchesTextKey = "MyMatchesText";
    [ResourceKey(defaultValue: "Please complete your User Profile first")]
    public const string CompletProfileTextKey = "CompletProfileText";
    [ResourceKey(defaultValue: "Age")]
    public const string AgeTextKey = "AgeText";
    [ResourceKey(defaultValue: "Distance")]
    public const string DistanceTextKey = "DistanceText";
    [ResourceKey(defaultValue: "View Details")]
    public const string ViewDetailsTextKey = "ViewDetailsText";
}
